<!-- src/main/resources/static/teacher/grades.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成绩管理 - 学工管理系统</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .nav {
            margin-bottom: 20px;
        }
        .nav a {
            margin-right: 10px;
            text-decoration: none;
            color: #007bff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            padding: 8px;
            width: 300px;
            margin-right: 10px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
            border-radius: 8px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="nav">
        <a href="/teacher/index.html">首页</a> |
        <a href="/teacher/schedule.html">课程安排</a> |
        <a href="/teacher/grades.html">成绩管理</a> |
        <a href="/announcements.html">公告查看</a> |
        <a href="#" onclick="logout()">退出</a>
    </div>

    <h2>成绩管理</h2>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="输入课程名称进行搜索">
        <button onclick="searchCourses()">搜索</button>
    </div>

    <table id="coursesTable">
        <thead>
        <tr>
            <th>课程代码</th>
            <th>课程名称</th>
            <th>学分</th>
            <th>操作</th>
        </tr>
        </thead>
        <tbody>
        <!-- 课程数据将通过JavaScript动态填充 -->
        </tbody>
    </table>

    <!-- 录入成绩模态框 -->
    <div id="gradeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>录入成绩 - <span id="modalCourseName"></span></h3>
            <input type="hidden" id="selectedCourseId">

            <div class="form-group">
                <label for="studentSelect">选择学生:</label>
                <select id="studentSelect"></select>
            </div>

            <div class="form-group">
                <label for="scoreInput">成绩:</label>
                <input type="number" id="scoreInput" min="0" max="100" step="0.1">
            </div>

            <div class="form-group">
                <label for="gradeTypeSelect">成绩类型:</label>
                <select id="gradeTypeSelect">
                    <option value="ORDINARY">平时成绩</option>
                    <option value="MIDTERM">期中成绩</option>
                    <option value="FINAL">期末成绩</option>
                    <option value="TOTAL">总评成绩</option>
                </select>
            </div>

            <button onclick="saveGrade()">保存成绩</button>
        </div>
    </div>
</div>

<script>
    // 页面加载时获取所有课程信息
    window.onload = function() {
        loadCourses();

        // 获取模态框元素
        const modal = document.getElementById("gradeModal");
        const span = document.getElementsByClassName("close")[0];

        // 点击关闭按钮关闭模态框
        span.onclick = function() {
            modal.style.display = "none";
        }

        // 点击模态框外部关闭它
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    };

    // 加载课程信息
    function loadCourses(query = '') {
        const url = query ? `/api/courses?q=${encodeURIComponent(query)}` : '/api/courses';

        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': 'Basic ' + btoa(getCredentials())
            }
        })
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#coursesTable tbody');
                tbody.innerHTML = '';

                if (data && data.length > 0) {
                    data.forEach(course => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td>${course.code || ''}</td>
                        <td>${course.name || ''}</td>
                        <td>${course.credit || ''}</td>
                        <td>
                            <button onclick="openGradeModal(${course.id}, '${course.name}')">录入成绩</button>
                        </td>
                    `;
                        tbody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="4">暂无课程信息</td>';
                    tbody.appendChild(row);
                }
            })
            .catch(error => {
                console.error('获取课程信息失败:', error);
            });
    }

    // 搜索课程
    function searchCourses() {
        const query = document.getElementById('searchInput').value;
        loadCourses(query);
    }

    // 打开录入成绩模态框
    function openGradeModal(courseId, courseName) {
        document.getElementById('selectedCourseId').value = courseId;
        document.getElementById('modalCourseName').textContent = courseName;

        // 加载该课程的学生列表
        loadStudentsForCourse(courseId);

        document.getElementById("gradeModal").style.display = "block";
    }

    // 加载课程的学生列表
    function loadStudentsForCourse(courseId) {
        // 这里应该调用API获取选修该课程的学生列表
        // 目前模拟一些数据
        const studentSelect = document.getElementById('studentSelect');
        studentSelect.innerHTML = '';

        // 模拟数据
        const students = [
            {id: 1, name: "张三"},
            {id: 2, name: "李四"},
            {id: 3, name: "王五"}
        ];

        students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = student.name;
            studentSelect.appendChild(option);
        });
    }

    // 保存成绩
    function saveGrade() {
        const courseId = document.getElementById('selectedCourseId').value;
        const studentId = document.getElementById('studentSelect').value;
        const score = document.getElementById('scoreInput').value;
        const gradeType = document.getElementById('gradeTypeSelect').value;

        // 构造成绩对象
        const gradeData = {
            courseId: parseInt(courseId),
            studentId: parseInt(studentId),
            score: parseFloat(score),
            gradeType: gradeType
        };

        // 调用API保存成绩
        fetch('/api/teacher/grades', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Basic ' + btoa(getCredentials())
            },
            body: JSON.stringify(gradeData)
        })
            .then(response => {
                if (response.ok) {
                    alert('成绩保存成功');
                    document.getElementById("gradeModal").style.display = "none";
                } else {
                    alert('成绩保存失败');
                }
            })
            .catch(error => {
                console.error('保存成绩失败:', error);
                alert('保存成绩失败');
            });
    }

    // 获取存储的凭据
    function getCredentials() {
        return localStorage.getItem('credentials') || '';
    }

    // 退出登录
    function logout() {
        localStorage.removeItem('credentials');
        window.location.href = '/login.html';
    }

    // 回车搜索
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchCourses();
        }
    });
</script>
</body>
</html>
