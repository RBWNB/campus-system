<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>学工系统登录</title>
  <style>
    body {
      font-family: Arial, Helvetica, sans-serif;
      background:#f2f2f2;
    }
    .login {
      width:320px;
      margin:120px auto;
      padding:20px;
      background:#fff;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .login h2{
      margin:0 0 12px 0;
      font-size:18px;
    }
    .login input {
      width:100%;
      padding:10px;
      margin:8px 0;
      box-sizing:border-box;
    }
    .login button {
      width:100%;
      padding:10px;
      background:#007bff;
      color:#fff;
      border:none;
      cursor:pointer;
    }
    .note {
      font-size:12px;
      color:#666;
      margin-top:10px;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 15px;
      color: #007bff;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    .register-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .register-section h3 {
      margin-top: 0;
      text-align: center;
    }
    .register-section input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      box-sizing: border-box;
    }
    .register-section button {
      width: 100%;
      padding: 10px;
      background: #28a745;
      color: #fff;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
<div class="login">
  <h2>学工管理系统 — 登录</h2>
  <form id="loginForm">
    <input type="text" id="username" placeholder="用户名" required />
    <input type="password" id="password" placeholder="密码" required />
    <button type="submit">登录 (HTTP Basic)</button>
  </form>
  <div class="note">说明：该页面通过浏览器 HTTP Basic 发起请求以便测试受保护接口。</div>
  <div class="note">默认管理员：admin / admin123，教师：teacher / teacher123，学生：student / student123</div>

  <div class="register-section">
    <h3>学生注册</h3>
    <form id="registerForm">
      <input type="text" id="regUsername" placeholder="用户名" required />
      <input type="password" id="regPassword" placeholder="密码" required />
      <button type="submit">注册</button>
    </form>
    <div class="note">说明：注册后会自动创建学生账户</div>
  </div>

  <a href="/index.html" class="back-link">返回首页</a>
</div>
<script>
  document.getElementById('loginForm').addEventListener('submit', function(e){
    e.preventDefault();
    var u = document.getElementById('username').value;
    var p = document.getElementById('password').value;
    var credentials = u + ':' + p;

    // 使用API验证用户身份并获取角色信息
    fetch('/api/auth/me', {
      method: 'GET',
      headers: { 'Authorization': 'Basic ' + btoa(credentials) }
    }).then(function(res){
      if (res.status === 200) {
        // 保存凭据到localStorage
        localStorage.setItem('credentials', credentials);

        // 获取用户详细信息以确定角色
        fetch('/api/student/profile', {
          method: 'GET',
          headers: { 'Authorization': 'Basic ' + btoa(credentials) }
        }).then(function(profileRes) {
          if (profileRes.status === 403) {
            // 管理员或教师角色
            window.location.href = '/admin/index.html'; // 或者 /teacher/index.html
          } else if (profileRes.status === 200) {
            // 学生角色
            window.location.href = '/student/index.html';
          } else {
            window.location.href = '/student/index.html';
          }
        }).catch(function() {
          window.location.href = '/student/index.html';
        });
      } else if (res.status === 401) {
        alert('认证失败：用户名或密码错误。');
      } else {
        alert('响应状态: ' + res.status);
      }
    }).catch(function(err){
      alert('请求失败: ' + err);
    });
  });

  // 注册功能
  document.getElementById('registerForm').addEventListener('submit', function(e){
    e.preventDefault();
    var username = document.getElementById('regUsername').value;
    var password = document.getElementById('regPassword').value;

    fetch('/api/auth/register', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        username: username,
        password: password
      })
    }).then(function(res){
      if (res.ok) {
        alert('注册成功，请登录');
        document.getElementById('regUsername').value = '';
        document.getElementById('regPassword').value = '';
      } else {
        res.text().then(text => alert('注册失败: ' + text));
      }
    }).catch(function(err){
      alert('请求失败: ' + err);
    });
  });
</script>
</body>
</html>
